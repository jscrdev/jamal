= Jamal AsciiDoc Extension

Use Jamal in IntelliJ interactively with AsciiDoc utilizing the AsciiDoc plugin.

image:images/splash.png[width=100%]

This document is the readme file for the Jamal Asciidoc extension version `1.12.4-SNAPSHOT`.

== Introduction



This Jamal module provides an extension for Asciidoc.
The extension is a preprocessor extension reading the input of the Asciidoc document before the actual transformation of Asciidoc happens.
Using this extension, you can configure your Asciidoc converted to invoke the Jamal preprocessing as part of the Asciidoc conversion.

The primary use case is using the extension with the IntelliJ IDEA plugin for Asciidoc.
Installing this extension, you can see the rendered and Jamal preprocessed Asciidoc result on the right editor pane while editing your `.adoc.jam` file.

It is not intended to be used as an exclusive way to execute Jamal when processing Asciidoc.

Maintaining a separate `.adoc.jam` and the generated `.adoc` file is a good solution.
For example, when you maintain your project on GitHub, the `.adoc` file is rendered by the platform on the file.
You can only do it if you have the Jamal preprocessed and generated `.adoc` file uploaded to GitHub.

== Installation with IntelliJ IDEA

[NOTE]
====
Asciidoc plugin is a plugin into IntelliJ.
The code in this module is not an IntelliJ plugin.
It is an extension to Asciidoctor, which itself is an IntelliJ plugin.
This way, this extension is an extension of a plugin.
You cannot install this extension as a separate plugin to IntelliJ.
It works only with the Asciidoc plugin in IntelliJ.
====


To use the plugin together with the IntelliJ Asciidoc plugin, you need the file `jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip`.

You can download this file from the central Maven repository using the URLs:


https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip[``https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip``]

https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip.asc[``https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip.asc``]

https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip.md5[``https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip.md5``]

https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip.sha1[``https://repo.maven.apache.org/maven2/com/javax0/jamal/jamal-asciidoc/1.12.3/jamal-asciidoc-1.12.3-jamal-asciidoc-distribution.zip.sha1``]

The ZIP file contains all the JAR files, the `.asc`, `.md5` and `.sha1` files are standard checksum files to check the integrity of the archive.

Extract the content of this zip file into your projects `.Asciidoctor/lib` folder.

Restart IntelliJ.
As soon as you open a file configured as Asciidoc and has the extension `.jam`, it will ask you:

image::images/trust.png[]

__This project contains Asciidoctor Extensions in .asciidoctor/lib that can be executed to render the preview. As this Ruby code runs as your local user, don't run this code unchecked.__

then select the first line that says

__I've checked the code and trust it, enable them!__

[NOTE]
====
Do not believe all that the message says.
It is not Ruby code.
This extension is written in Java.
However, using the Jamal Ruby extension, you may execute some Ruby code in your Asciidoc document.
But only if you want.
====

Open the Preferences window of IntelliJ and select `File Types`.
Under the recognized file types, select `AsciiDoc files`.
Under the `File name patterns:` click on the plus sign and add `*.jam`

image::images/intellij-configure-file-types.png[width=100%]

It will associate the Asciidoctor plugin with the files with the `.jam` extension.
The Jamal extension does not start the processing when you look at files that do not have the `.jam` ending.

Start editing the `.jam` file and look at the right pane at the rendered document.

[NOTE]
====
Before version 1.12.4, associating Asciidoc with the extension `.adoc.jam` was recommended.
Starting with this release, you can use the extension for Jamal files, which are not in asciidoc format.
The extension sees when the processed file does NOT have the `.adoc` file name extension in front of the final `.jam` extension.
In this case, the generated output for the display will get a `[source]\n----\n` prefix and a `----\n` postfix.
It will make the asciidoctor plugin display the content as preformatted source code.

The extension does not add the prefix and postfix to the saved file.
It is added only to the text for the display.
====

== Usage

After the installation, you can open any file that has the extension `.adoc.jam` and have a look at the right pane at the rendered document.

The default macro opening and closing strings are {% and %}.
It is the usual convention when editing Asciidoc files with Jamal preprocessor.
The reason for this is because these documents many times include sample code snippets that frequently may have `{` and `}` in them.
If you want to use `{` and `}` as macro opening and closing strings, then start your file with the line:

[source]
----
{@comment }
----

When the first two characters of the document are `{@`, then the macro opening and closing strings will be `{` and `}`.
It is what the core built-in macro `import` also does.

=== Configuration

You can configure the extension using the Jamal built-in configuration mechanism, which uses

* environment variables,
* system variables, or
* properties files.

The configuration uses the exact mechanism that Jamal uses when searching for configuration options.
The search order and key name translations are described in the documentation of the macro link:../README.adoc#env[`env`].

When looking for a configuration value `X_Y_Z`, then the following search order is used:

* First, the code looks at the Java system properties for `x.y.z`.
* If there is no system property with that name, it looks at the environment variable `X_Y_Z`.
* Finally, it tries to look up the configuration value `x.y.z` from the `~/.jamal/setting.properties` or `~/.jamal/setting.xml` file.

The following configuration values are supported:

* `ASCIIDOC_EXTENSION_OPEN` can define the macro opening string. The default value is {%.
* `ASCIIDOC_EXTENSION_CLOSE` can define the macro closing string. The default value is %}.
* `ASCIIDOC_EXTENSION_NOSAVE` can be `true` or `false`, and it defines whether the extension should save the rendered document to the file system.
The default value is `false`, meaning that the rendered document is saved to the file system.
* `ASCIIDOC_EXTENSION_LOG` can be `true` or `false`, defining whether the extension should log the rendering.
The default value is `false`, meaning no logging by default.
* `ASCIIDOC_EXTENSION_EXTERNAL` can instruct the extension to start Jamal as an external process, convert the input to the output and then read the lines of the generated file and return it for the Asciidoc plugin.
The external command to be executed can be configured using the next, `ASCIIDOC_EXTENSION_EXTERNAL_COMMAND` configuration.
Note that starting an external process may need significant resource and may significantly slow down the rendering.
* `ASCIIDOC_EXTENSION_EXTERNAL_COMMAND` can specify the command to execute when the preprocessing is done using an external process.
* `ASCIIDOC_EXTENSION_NO_DEPENDENCIES` can be `true` or `false` defining whether the extension should consider the included files change when caching.
The option is `false` by default, which means that the caching examines all the included, imported and other files that were used during the processing.

Note that these names should be translated to lower case and use `.` as separator instead of `_` when using the `~/.jamal/setting.properties` or `~/.jamal/setting.xml` file. Foe example, in the `~/.jamal/setting.properties` file you should write

    asciidoc.extension.log=true

instead of `ASCIIDOC_EXTENSION_LOG`.

=== Options

You can alter the auxiliary functions of the extension using options.
You can place these options into the document's first line into a comment.
If an option is defined for something controllable by configuration, then the option will take precedence.

[source]
----
{@comment off nosave log}
----

or

[source]
----
{%@comment off nosave log%}
----

You can place any of the options listed in the above example separated by spaces in any order.

==== off

Sometimes you may want to switch off the Jamal preprocessor for a specific document.
The output of the preprocessing will be the same as the input.
This way, the Asciidoc rendering will not be affected by the preprocessing.

==== nosave

The extension saves the preprocessed document in the `.adoc` file by default.
It is assumed that if you have a file named `xxxx.adoc.jam`, then your `xxxx.adoc` file is generated.

Use this option to switch off this file writing.
You may need it on some older machines or in the case of extensive documents to improve performance.

==== log

You may be interested in how many times and when the extension regenerated the output file.
To get that information, you can use the option `log` as

[soure]
----
{@comment log}
----

in the first line of the document.
It will instruct the extension to append a line like

----
[INFO] 2022-03-26T12:14:49.303437 saved
----

to the log file.
The log file's name is the same as the output file with the extension `.log` appended.
For example, if you edit the file `README.adoc.jam`, the output file will be `README.adoc`, and the log file will be `README.adoc.log`.

This log file can overgrow and become fat.
Feel free to delete the log file.

==== external

In some cases you may need to execute the rendering using an external process.
This option instructs the extension to start Jamal as an external process, convert the input to the output and then read the lines of the generated file and return it for the Asciidoc plugin.

==== noDependencies

It defines that the preprocessor should not consider the included, imported or any other way used files when deciding about the cached result of the rendering.

The IntelliJ Asciidoctor plugin invokes the rendering and the preprocessor in it many times, even when the documentum has not changed.
To ease the burden on the processor the Jamal preprocessor keeps the last execution's result in memory.
When there was no change in any of the files that the processing used then the canned result is returned.
When this option is used then only the edited file is consulted and the other files included, imported or any other way used are not considered.
It means that the file on the screen may not update when one of the included files change.
In that case you have to change the edited file, for example inserting and deleting a space.

This option may be needed when the rendered file reads a lot of other files, using snippets, includes and imports.
This option saves some CPU time when these files do not change.

== Modules

When using Jamal, you probably want to use extra built-in macros in addition to the core modules.
The ZIP file you extracted to the `.Asciidoctor/lib` folder contains the following modules:



* `jamal-extensions`

* `jamal-snippet`

* `jamal-test`

* `jamal-scriptbasic`

* `jamal-groovy`

* `jamal-ruby`

* `jamal-plantuml`

* `jamal-debug`

* `jamal-jamal`

* `jamal-yaml`

* `jamal-io`

* `jamal-assertions`

* `jamal-markdown`

* `jamal-mock`


It is essentially all the macro modules that come with Jamal by default.
If you want to use additional modules, all you have to do is copy the `.jar` files to the `.Asciidoctor/lib` folder.
The IntelliJ Asciidoc plugin will automatically load the modules.

== Error Handling

When the Asciidoc conversion finds an error in the document, it still renders the document and creates a preview.
You can do it because Asciidoc is a format where the cohesion between the different parts is not too strong.
If there is an error in the code, the rest of the document may still be rendered and look the same.

Jamal, on the other hand, is a complex macro language.
Likely, it is not possible to reasonably process the input after some error.
If there is an error in the input, the Jamal processor will not produce an output.
As a most functional approach, the extension will result in the input without preprocessing but enriched with error messages.

The extension will insert the error message given by the Jamal processor to the document's start as a WARNING admonition.
It will also insert the same admonition at the line where the error is and at the end of the document.
The error message at the end of the document is followed by a source block, including the full stack trace.

This way, it may be easier to find the error in the document and still see some preview while the input is erroneous.

== Executing External Jamal

It is possible to run Jamal as an external process and get the output of the preprocessing.
To do that you should configure the external command to execute.
The configuration key is `ASCIIDOC_EXTENSION_EXTERNAL_COMMAND`.
When it is configured in a properties file you should use `asciidoc.extension.external.command`.

For example, the configuration file `~/.jamal/settings.properties` contains the following line on the development machine:

[source]
----
asciidoc.extension.external.command=/Users/verhasp/.jbang/bin/jbang jamal@verhas -open=\{% -close=%\} $1 $2
----

As you can see, I use `jbang` to execute Jamal as an external command.
It is also to note that the `PATH` environment variable may not be available and for this reason the full path is specified.

When executing the external command the placeholder `$1` will be replaced by the input file name and `$2` by the output file name.
The output file name is the same as the input file name without the `.jam` extension.
The extension checks the options in the first line of the document, but in case the execution is done externally the options are ignored, except the `external` option.

[NOTE]
====
This option was developed as a last resort.
For example, during the development the Java JDK used by IntelliJ and hence used to execute Jamal could not find the JShell engine.
The main README uses the JShell engine when it discusses the feature.
With this option the main README can also be edited WYSIWYG style.
====

[WARNING]
====
You may recognize that using this option you can execute any external command.
Keep your `~/.jamal/settings.properties` file secure.
Configure the external command to execute only if you have no other way to use the extension.
====

== Cache

The IntelliJ plugin AsciiDoctor renderer seems to run multiple times even when the file does not change.
Asciidoc rendering may not be cheap, but Jamal processing and the rendering can be really expensive.
Please note, that Jamal is almost a full programming language, and you can create fairly complex structures.
However, Jamal processing is supposed to be idempotent.
If you have the same source you are supposed to get the same output.

[NOTE]
====
If you want to see how many times and when the preprocessor was executed switch on the logging.
You will see in the log file something like the following:

[source,text]
----
2022-05-13T16:21:21.993262 [993:3989:5E7D6DDB]ApplicationImpl pooled thread 364 started
2022-05-13T16:21:21.997498 [993:3989:5E7D6DDB]ApplicationImpl pooled thread 364 md5 Ei3ZRs4l2zH8J19bzE1KWQ==
2022-05-13T16:21:22.009581 [993:3989:5E7D6DDB]ApplicationImpl pooled thread 364 saved
2022-05-13T16:21:22.255684 [994:3990:75BA8F1E]Alarm Pool started
2022-05-13T16:21:22.258885 [994:3990:75BA8F1E]Alarm Pool md5 Ei3ZRs4l2zH8J19bzE1KWQ==
2022-05-13T16:21:22.259281 [994:3990:75BA8F1E]Alarm Pool restored
2022-05-13T16:21:22.268355 [994:3990:75BA8F1E]Alarm Pool saved
----

The log shows you

* the time when the preprocessor was started
* a counter (993 and 994 in this example), which starts from zero when you start IntelliJ and increments for every preprocessor invocation
* the thread identifier executing the preprocessor
* the hash code of the preprocessor object (you can see that the plugin creates a new preprocessor object for every execution, it is okay)
* `started` the preprocessor _start_
* `saved` the preprocessor _end_, when it saves the result back into the Asciidoctor source
* the md5 fingerprint of the input
* `restored` when the fingerprint shows that the input did not change since the last run

The logging is a troubleshooting feature and there is no guarantee that this document follows the changes of the logging format.
====

The Jamal Asciidoctor preprocessor stores the result of the last processing (in memory) and if it sees the same input next time it just returns the already calculated output.
The last result is really the last result, even when you keep multiple `.adoc.jam` files in your IntelliJ open.
Editing one of the files will overwrite in the memory the last result form the other file.
This, however, affects only the speed.
The resulting output files, which the preprocessor saves by default, or the rendering results are never affected by this caching.
